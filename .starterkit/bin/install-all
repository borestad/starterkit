#!/usr/bin/env bash
set +x -eEu

. `dirname $0`/_helpers

hr
echo -e "âš¡ Install dependencies"

cd $ROOT
install-git-lfs
cd $ROOT

YARN_WANTED_VERSION=`node -p -e require\(\'./package.json\'\).dependencies.yarn`
YARN_INSTALLED_VERSION=`node -p -e require\(\'./node_modules/yarn/package.json\'\).version 2>/dev/null | tr -d '\n'` || '0'
YARN_ARGS='--frozen-lockfile --link-duplicates --non-interactive --no-progress'
YARN_METHOD=''


if [ "$YARN_WANTED_VERSION" == "$YARN_INSTALLED_VERSION" ]
then
  # Use local yarn version
  color=$Gre
  YARN_METHOD="$color local$R"
  cmd="./node_modules/.bin/yarn $YARN_ARGS"
else
  # Use npx instead
  color=$Red
  YARN_METHOD="$color npx$R"
  cmd="npx yarn@$YARN_WANTED_VERSION $YARN_ARGS"
fi

echo -e "ðŸ’¥ yarn [ required version ]      $color$YARN_WANTED_VERSION$R"
echo -e "ðŸ’¥ yarn [ installed version ]     $color$YARN_INSTALLED_VERSION$R"
echo -e "ðŸ’¥ yarn [ installation ]          $YARN_METHOD"

echo
echo -e "$Gray\$ $cmd $R"
echo

$cmd