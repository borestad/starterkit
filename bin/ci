#!/bin/bash
set +x -eEu

export PATH="./node_modules/.bin:$PATH"
#export PATH="./node_modules/chromium/lib"

. `dirname $0`/_helpers

cd $ROOT

trap trap-exit EXIT
trap trap-error INT TERM

hr '-'

npx envinfo --system --binaries

line '[1/7] Cleanup'
yarn clean

line '[2/7] Install'
yarn --pure-lockfile --link-duplicates --skip-integrity-check --no-progress --non-interactive

line '[3/7] Codestyle & Lint'
yarn fix

line '[4/7] Compile'
yarn compile

line '[5/7] Run tests'
yarn test:unit
yarn test:e2e

line '[6/7] Build packages'
yarn build

line '[7/7] Publish packages (if version is bumped)'
$ROOT/bin/publish

line