#!/bin/bash
set +x -eEu

# Update the index
git update-index --again

# Delete untracked files in .gitignore
git ls-files --ignored --exclude-standard -z | xargs -0 git rm --cached 2>/dev/null || echo

export PATH="./node_modules/.bin:$PATH"

. `dirname $0`/_helpers

cd $ROOT

git-validate-repo

trap trap-exit EXIT
trap trap-error INT TERM

npx envinfo --system --binaries

line '[1/8] Cleanup'
npm run clean

line '[2/8] Install'
$ROOT/bin/install-all

line '[3/8] Custom validation'
# ./bin/validate

line '[3/8] Codestyle & Lint'
yarn prettier --loglevel silent
yarn lint
git-validate-repo


line '[4/8] Compile'
yarn compile
git-validate-repo

line '[5/8] Run tests'
yarn test:unit
yarn test:e2e
git-validate-repo

line '[6/8] Build packages'
yarn build
git-validate-repo

line '[7/8] Publish packages (if version is bumped)'
$ROOT/bin/publish

line