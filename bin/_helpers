#!/bin/bash -eEu

export ARTIFACTORY_NPM_REGISTRY=https://artifactory.netent.com/artifactory/api/npm/casino-software-snapshots-npm-local
export ROOT=$(git rev-parse --show-toplevel)
export PATH="./node_modules/.bin:$PATH"

hr () {
  $ROOT/bin/hr "${@:--}"
}

hr2 () {
  echo -e "${On_Bla}${Whi}`$ROOT/bin/hr $@`${RCol}"
}


git-validate-repo () {
  # Hackish strategy to get rid of git-dirty files, caused by GDP
  #   - always add pom.xml to local build on Jenkins (but not push it)
  #   - never fail
  (git add $ROOT/pom.xml && git commit -m "Update pom.xml") &>/dev/null && hr && echo 'Update pom.xml' && hr || :

  git-is-repo-dirty || (echo 'dirty' && git-show-dirty-repo-error)
}

git-is-repo-clean () {
    ! [ -z "$(git status --porcelain)" ]
}

git-is-repo-dirty () {
    ! git-is-repo-clean
}

git-show-dirty-repo-error () {
  print-failure

  echo -e $Red
  cat << "EOF"
  ðŸ’© Whoopsie poopsie! ðŸ’©

  Your friendly linter found some errors ...
    ...and this has caused the repository to become "dirty"

  "dirty" = The working tree has uncommitted changes (caused by the linter)
            and now needs to be cleaned up to give you a green light!

  This is often caused by:

    ðŸ˜‡ - Files not being formatted properly before commit.
    ðŸº - Alcohol was involved
    ðŸ‘½ - Random noise from space
    â˜• - Lack of coffee

  99% of the time - this should automatically be solved by our nifty pre-commit hook (see .lintstagedrc.js).
  This hook autofixes almostâ„¢ all these annoying messages.

  Also, if you're using Visual Studio Code - you'll get autofix on save.
  (Just make sure to install the prettier plugin)

  Please run "yarn fix" and try to commit again.

  Have a nice day! â¤ï¸

  Pssst! Here's a pretty "git diff" of what went wrong
EOF
  echo -e $RCol
  echo
  git status -s
  echo
  git diff --color | $ROOT/node_modules/.bin/diff-so-fancy
  line
  exit 1
}

trap-exit () {
  err=$?
}

trap-error () {
  err=$?
  print-failure
}


# ===================================_he==========================================
# âš¡ COLORS
# =============================================================================

# Text Reset
RCol="\033[0m"
R="\033[0m"

# Regular           Bold                Underline           High Intensity      BoldHigh Intens     Background
Bla='\033[30m';     BBla='\033[30m';    UBla='\e[4;30m';    IBla='\033[90m';    BIBla='\033[90m';   On_Bla='\e[40m';
Red="\033[31m";     BRed='\033[31m';    URed='\e[4;31m';    IRed='\033[91m';    BIRed='\033[91m';   On_Red='\e[41m';
Gre='\033[32m';     BGre='\033[32m';    UGre='\e[4;32m';    IGre='\033[92m';    BIGre='\033[92m';   On_Gre='\e[42m';
Yel='\033[33m';     BYel='\033[33m';    UYel='\e[4;33m';    IYel='\033[93m';    BIYel='\033[93m';   On_Yel='\e[43m';
Blu='\033[34m';     BBlu='\033[34m';    UBlu='\e[4;34m';    IBlu='\033[94m';    BIBlu='\033[94m';   On_Blu='\e[44m';
Pur='\033[35m';     BPur='\033[35m';    UPur='\e[4;35m';    IPur='\033[95m';    BIPur='\033[95m';   On_Pur='\e[45m';
Cya='\033[36m';     BCya='\033[36m';    UCya='\e[4;36m';    ICya='\033[96m';    BICya='\033[96m';   On_Cya='\e[46m';
Whi='\033[37m';     BWhi='\033[37m';    UWhi='\e[4;37m';    IWhi='\033[97m';    BIWhi='\033[97m';   On_Whi='\e[47m';
Gray='\033[90m';

# =============================================================================
# âš¡ HELPER FUNCTIONS
# =============================================================================

ansi()          { echo -e "âš¡ \e[${1}m${*:2}\e[0m"; }
bold()          { ansi 1 "$@"; }
italic()        { ansi 3 "$@"; }
underline()     { ansi 4 "$@"; }
strikethrough() { ansi 9 "$@"; }
red()           { echo; ansi 31 "$@"; echo;}


line () {
  local text=$@
  echo ""
  hr '-'
  [ ! -z "$text" ] && echo -e "âš¡ ${text}"
  echo ""
}



print-success () {
echo -e $Gre
# http://patorjk.com/software/taag/#p=display&h=0&v=1&f=Big&t=SUCCESS
cat << "EOF"

   _____   _    _    _____    _____   ______    _____    _____
  / ____| | |  | |  / ____|  / ____| |  ____|  / ____|  / ____|
 | (___   | |  | | | |      | |      | |__    | (___   | (___
  \___ \  | |  | | | |      | |      |  __|    \___ \   \___ \
  ____) | | |__| | | |____  | |____  | |____   ____) |  ____) |
 |_____/   \____/   \_____|  \_____| |______| |_____/  |_____/

   - Well done, sir!

EOF
echo -e $RCol
}

print-failure () {
echo -e $Red
# http://patorjk.com/software/taag/#p=display&h=0&v=1&f=Big&t=OH%20NOSE!
cat << "EOF"

   ____    _    _     _   _    ____     _____   ______   _
  / __ \  | |  | |   | \ | |  / __ \   / ____| |  ____| | |
 | |  | | | |__| |   |  \| | | |  | | | (___   | |__    | |
 | |  | | |  __  |   | . ` | | |  | |  \___ \  |  __|   | |
 | |__| | | |  | |   | |\  | | |__| |  ____) | | |____  |_|
  \____/  |_|  |_|   |_| \_|  \____/  |_____/  |______| (_)

   - You haz errors :(

EOF
echo -e $RCol

}

